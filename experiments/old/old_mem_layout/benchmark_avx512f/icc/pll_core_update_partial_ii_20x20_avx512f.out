Source Line  Source                                                                                                 CPU Time  CPU Time:Effective Time  CPU Time:Effective Time:Idle  CPU Time:Effective Time:Poor  CPU Time:Effective Time:Ok  CPU Time:Effective Time:Ideal  CPU Time:Effective Time:Over  CPU Time:Spin Time  CPU Time:Overhead Time  Instructions Retired  CPI Rate  CPU Frequency Ratio
-----------  -----------------------------------------------------------------------------------------------------  --------  -----------------------  ----------------------------  ----------------------------  --------------------------  -----------------------------  ----------------------------  ------------------  ----------------------  --------------------  --------  -------------------
517          //  }                                                                                                                                                                                                                                                                                                                                                                                         
518          }                                                                                                                                                                                                                                                                                                                                                                                             
519                                                                                                                                                                                                                                                                                                                                                                                                        
520                                                                                                                                                                                                                                                                                                                                                                                                        
521          PLL_EXPORT                                                                                                                                                                                                                                                                                                                                                                                    
522          void pll_core_update_partial_ii_20x20_avx512f(unsigned int sites,                                                                                                                                                                                                                                                                                                                             
523                                                        unsigned int rate_cats,                                                                                                                                                                                                                                                                                                                         
524                                                        double *parent_clv,                                                                                                                                                                                                                                                                                                                             
525                                                        unsigned int *parent_scaler,                                                                                                                                                                                                                                                                                                                    
526                                                        const double *left_clv,                                                                                                                                                                                                                                                                                                                         
527                                                        const double *right_clv,                                                                                                                                                                                                                                                                                                                        
528                                                        const double *left_matrix,                                                                                                                                                                                                                                                                                                                      
529                                                        const double *right_matrix,                                                                                                                                                                                                                                                                                                                     
530                                                        const unsigned int *left_scaler,                                                                                                                                                                                                                                                                                                                
531                                                        const unsigned int *right_scaler,                                                                                                                                                                                                                                                                                                               
532                                                        unsigned int attrib) {                                                                                                                                                                                                                                                                                                                          
533            unsigned int i, k, n;                                                                                                                                                                                                                                                                                                                                                                       
534                                                                                                                                                                                                                                                                                                                                                                                                        
535            const double *lmat;                                                                                                                                                                                                                                                                                                                                                                         
536            const double *rmat;                                                                                                                                                                                                                                                                                                                                                                         
537                                                                                                                                                                                                                                                                                                                                                                                                        
538            unsigned int states = 20;                                                                                                                                                                                                                                                                                                                                                                   
539            unsigned int states_padded = (states + 7) & (0xFFFFFFFF - 7);                                                                                                                                                                                                                                                                                                                               
540            unsigned int span_padded = states_padded * rate_cats;                                                  0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
541                                                                                                                                                                                                                                                                                                                                                                                                        
542            /* scaling-related stuff */                                                                                                                                                                                                                                                                                                                                                                 
543            unsigned int scale_mode;  /* 0 = none, 1 = per-site, 2 = per-rate */                                                                                                                                                                                                                                                                                                                        
544            unsigned int scale_mask;                                                                                                                                                                                                                                                                                                                                                                    
545            unsigned int init_mask;                                                                                                                                                                                                                                                                                                                                                                     
546            __m512d v_scale_threshold = _mm512_set1_pd(PLL_SCALE_THRESHOLD);                                                                                                                                                                                                                                                                                                                            
547            __m512d v_scale_factor = _mm512_set1_pd(PLL_SCALE_FACTOR);                                                                                                                                                                                                                                                                                                                                  
548                                                                                                                                                                                                                                                                                                                                                                                                        
549            __m512i switch_256lanes_mask = _mm512_setr_epi64(4,                                                                                                                                                                                                                                                                                                                                         
550                                                         5,                                                                                                                                                                                                                                                                                                                                             
551                                                         6,                                                                                                                                                                                                                                                                                                                                             
552                                                         7,                                                                                                                                                                                                                                                                                                                                             
553                                                         1,                                                                                                                                                                                                                                                                                                                                             
554                                                         2,                                                                                                                                                                                                                                                                                                                                             
555                                                         3,                                                                                                                                                                                                                                                                                                                                             
556                                                         4);                                                                                                                                                                                                                                                                                                                                            
557            __m512i permute_mask = _mm512_setr_epi64(0 | 4,                                                                                                                                                                                                                                                                                                                                             
558                                                     0 | 5,                                                                                                                                                                                                                                                                                                                                             
559                                                     0 | 6,                                                                                                                                                                                                                                                                                                                                             
560                                                     0 | 7,                                                                                                                                                                                                                                                                                                                                             
561                                                     8 | 0,                                                                                                                                                                                                                                                                                                                                             
562                                                     8 | 1,                                                                                                                                                                                                                                                                                                                                             
563                                                     8 | 2,                                                                                                                                                                                                                                                                                                                                             
564                                                     8 | 3);                                                                                                                                                                                                                                                                                                                                            
565            __m512i permute_mask_final_stage = _mm512_setr_epi64(0 | 2,                                                                                                                                                                                                                                                                                                                                 
566                                                                 0 | 3,                                                                                                                                                                                                                                                                                                                                 
567                                                                 8 | 0,                                                                                                                                                                                                                                                                                                                                 
568                                                                 8 | 1,                                                                                                                                                                                                                                                                                                                                 
569                                                                 0 | 6,                                                                                                                                                                                                                                                                                                                                 
570                                                                 0 | 7,                                                                                                                                                                                                                                                                                                                                 
571                                                                 8 | 4,                                                                                                                                                                                                                                                                                                                                 
572                                                                 8 | 5);                                                                                                                                                                                                                                                                                                                                
573                                                                                                                                                                                                                                                                                                                                                                                                        
574            if (!parent_scaler) {                                                                                                                                                                                                                                                                                                                                                                       
575              /* scaling disabled / not required */                                                                                                                                                                                                                                                                                                                                                     
576              scale_mode = init_mask = 0;                                                                          0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
577            } else {                                                                                                                                                                                                                                                                                                                                                                                    
578              /* determine the scaling mode and init the vars accordingly */                                                                                                                                                                                                                                                                                                                            
579              scale_mode = (attrib & PLL_ATTRIB_RATE_SCALERS) ? 2 : 1;                                                                                                                                                                                                                                                                                                                                  
580              init_mask = (scale_mode == 1) ? 0xF : 0;                                                                                                                                                                                                                                                                                                                                                  
581              const size_t scaler_size = (scale_mode == 2) ? sites * rate_cats : sites;                                                                                                                                                                                                                                                                                                                 
582              /* add up the scale vector of the two children if available */                                                                                                                                                                                                                                                                                                                            
583              fill_parent_scaler(scaler_size, parent_scaler, left_scaler, right_scaler);                                                                                                                                                                                                                                                                                                                
584            }                                                                                                                                                                                                                                                                                                                                                                                           
585                                                                                                                                                                                                                                                                                                                                                                                                        
586            size_t displacement = (states_padded - states) * (states_padded);                                                                                                                                                                                                                                                                                                                           
587                                                                                                                                                                                                                                                                                                                                                                                                        
588            /* compute CLV */                                                                                                                                                                                                                                                                                                                                                                           
589            for (n = 0; n < sites; ++n) {                                                                                                                                                                                                                                                                                                                                                               
590              lmat = left_matrix;                                                                                                                                                                                                                                                                                                                                                                       
591              rmat = right_matrix;                                                                                                                                                                                                                                                                                                                                                                      
592              scale_mask = init_mask;                                                                                                                                                                                                                                                                                                                                                                   
593                                                                                                                                                                                                                                                                                                                                                                                                        
594              for (k = 0; k < rate_cats; ++k) {                                                                    0.030s                   0.030s                            0s                        0.030s                          0s                             0s                            0s                  0s                      0s            39,000,000     1.000                1.000
595                __mmask8 rate_mask = 0xF;                                                                                                                                                                                                                                                                                                                                                               
596                                                                                                                                                                                                                                                                                                                                                                                                        
597                PROCESS_8_ROWS(0);                                                                                 1.480s                   1.480s                            0s                        1.480s                          0s                             0s                            0s                  0s                      0s         2,015,000,000     0.955                1.000
598                PROCESS_8_ROWS(8);                                                                                 1.120s                   1.120s                            0s                        1.120s                          0s                             0s                            0s                  0s                      0s         1,976,000,000     0.737                1.000
599                                                                                                                                                                                                                                                                                                                                                                                                        
600                __m512d v_terma0 = _mm512_setzero_pd();                                                                                                                                                                                                                                                                                                                                                 
601                __m512d v_termb0 = _mm512_setzero_pd();                                                                                                                                                                                                                                                                                                                                                 
602                __m512d v_terma1 = _mm512_setzero_pd();                                                                                                                                                                                                                                                                                                                                                 
603                __m512d v_termb1 = _mm512_setzero_pd();                                                                                                                                                                                                                                                                                                                                                 
604                __m512d v_terma2 = _mm512_setzero_pd();                                                                                                                                                                                                                                                                                                                                                 
605                __m512d v_termb2 = _mm512_setzero_pd();                                                                                                                                                                                                                                                                                                                                                 
606                __m512d v_terma3 = _mm512_setzero_pd();                                                                                                                                                                                                                                                                                                                                                 
607                __m512d v_termb3 = _mm512_setzero_pd();                                                                                                                                                                                                                                                                                                                                                 
608                                                                                                                                                                                                                                                                                                                                                                                                        
609                __m512d v_mat;                                                                                                                                                                                                                                                                                                                                                                          
610                __m512d v_lclv;                                                                                                                                                                                                                                                                                                                                                                         
611                __m512d v_rclv;                                                                                                                                                                                                                                                                                                                                                                         
612                                                                                                                                                                                                                                                                                                                                                                                                        
613                /* point to the four rows of the left matrix */                                                                                                                                                                                                                                                                                                                                         
614                const double *lm0 = lmat;                                                                                                                                                                                                                                                                                                                                                               
615                const double *lm1 = lm0 + states_padded;                                                                                                                                                                                                                                                                                                                                                
616                const double *lm2 = lm1 + states_padded;                                                                                                                                                                                                                                                                                                                                                
617                const double *lm3 = lm2 + states_padded;                                                                                                                                                                                                                                                                                                                                                
618                                                                                                                                                                                                                                                                                                                                                                                                        
619                /* point to the four rows of the right matrix */                                                                                                                                                                                                                                                                                                                                        
620                const double *rm0 = rmat;                                                                                                                                                                                                                                                                                                                                                               
621                const double *rm1 = rm0 + states_padded;                                                                                                                                                                                                                                                                                                                                                
622                const double *rm2 = rm1 + states_padded;                                                                                                                                                                                                                                                                                                                                                
623                const double *rm3 = rm2 + states_padded;                                                                                                                                                                                                                                                                                                                                                
624                                                                                                                                                                                                                                                                                                                                                                                                        
625                PROCESS_8_COLS_HALF(0);                                                                            0.140s                   0.140s                            0s                        0.140s                          0s                             0s                            0s                  0s                      0s            26,000,000     7.000                1.000
626                PROCESS_8_COLS_HALF(8);                                                                            0.090s                   0.090s                            0s                        0.090s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
627                PROCESS_8_COLS_HALF(16);                                                                           0.050s                   0.050s                            0s                        0.050s                          0s                             0s                            0s                  0s                      0s           156,000,000     0.417                1.000
628                                                                                                                                                                                                                                                                                                                                                                                                        
629                /* point pmatrix to the next four rows */                                                                                                                                                                                                                                                                                                                                               
630                lmat += 8 * states_padded;                                                                         0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
631                rmat += 8 * states_padded;                                                                         0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
632                                                                                                                                                                                                                                                                                                                                                                                                        
633                __m512d xmm0 = _mm512_unpackhi_pd(v_terma0, v_terma1);                                             0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s            26,000,000     0.500                1.000
634                __m512d xmm1 = _mm512_unpacklo_pd(v_terma0, v_terma1);                                             0.020s                   0.020s                            0s                        0.020s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
635                                                                                                                                                                                                                                                                                                                                                                                                        
636                __m512d xmm2 = _mm512_unpackhi_pd(v_terma2, v_terma3);                                                 0s                       0s                            0s                            0s                          0s                             0s                            0s                  0s                      0s            39,000,000     0.000                0.000
637                __m512d xmm3 = _mm512_unpacklo_pd(v_terma2, v_terma3);                                             0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s            39,000,000     0.333                1.000
638                                                                                                                                                                                                                                                                                                                                                                                                        
639                xmm0 = _mm512_add_pd(xmm0, xmm1);                                                                  0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s            26,000,000     0.500                1.000
640                xmm1 = _mm512_add_pd(xmm2, xmm3);                                                                  0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
641                                                                                                                                                                                                                                                                                                                                                                                                        
642                xmm2 = _mm512_permutex2var_pd(xmm0, permute_mask_final_stage, xmm1);                               0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s            65,000,000     0.200                1.000
643                                                                                                                                                                                                                                                                                                                                                                                                        
644                xmm3 = _mm512_mask_blend_pd(0xCC, xmm0, xmm1);                                                     0.020s                   0.020s                            0s                        0.020s                          0s                             0s                            0s                  0s                      0s            13,000,000     2.000                1.000
645                                                                                                                                                                                                                                                                                                                                                                                                        
646                __m512d blend = _mm512_add_pd(xmm2, xmm3);                                                             0s                       0s                            0s                            0s                          0s                             0s                            0s                  0s                      0s            39,000,000     0.000                0.000
647                                                                                                                                                                                                                                                                                                                                                                                                        
648                __m512d v_terma_sum = _mm512_add_pd(blend, _mm512_permutexvar_pd(switch_256lanes_mask, blend));    0.040s                   0.040s                            0s                        0.040s                          0s                             0s                            0s                  0s                      0s            52,000,000     1.000                1.000
649                                                                                                                                                                                                                                                                                                                                                                                                        
650                /* compute termb */                                                                                                                                                                                                                                                                                                                                                                     
651                                                                                                                                                                                                                                                                                                                                                                                                        
652                xmm0 = _mm512_unpackhi_pd(v_termb0, v_termb1);                                                                                                                                                                                                                                                                                                                                          
653                xmm1 = _mm512_unpacklo_pd(v_termb0, v_termb1);                                                     0.020s                   0.020s                            0s                        0.020s                          0s                             0s                            0s                  0s                      0s            39,000,000     0.667                1.000
654                                                                                                                                                                                                                                                                                                                                                                                                        
655                xmm2 = _mm512_unpackhi_pd(v_termb2, v_termb3);                                                     0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s            39,000,000     0.333                1.000
656                xmm3 = _mm512_unpacklo_pd(v_termb2, v_termb3);                                                     0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
657                                                                                                                                                                                                                                                                                                                                                                                                        
658                xmm0 = _mm512_add_pd(xmm0, xmm1);                                                                      0s                       0s                            0s                            0s                          0s                             0s                            0s                  0s                      0s            13,000,000     0.000                0.000
659                xmm1 = _mm512_add_pd(xmm2, xmm3);                                                                  0.030s                   0.030s                            0s                        0.030s                          0s                             0s                            0s                  0s                      0s            52,000,000     0.750                1.000
660                                                                                                                                                                                                                                                                                                                                                                                                        
661                xmm2 = _mm512_permutex2var_pd(xmm0, permute_mask_final_stage, xmm1);                               0.030s                   0.030s                            0s                        0.030s                          0s                             0s                            0s                  0s                      0s            52,000,000     0.750                1.000
662                                                                                                                                                                                                                                                                                                                                                                                                        
663                xmm3 = _mm512_mask_blend_pd(0xCC, xmm0, xmm1);                                                     0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s            52,000,000     0.250                1.000
664                                                                                                                                                                                                                                                                                                                                                                                                        
665                blend = _mm512_add_pd(xmm2, xmm3);                                                                 0.020s                   0.020s                            0s                        0.020s                          0s                             0s                            0s                  0s                      0s            13,000,000     2.000                1.000
666                                                                                                                                                                                                                                                                                                                                                                                                        
667                __m512d v_termb_sum = _mm512_add_pd(blend, _mm512_permutexvar_pd(switch_256lanes_mask, blend));    0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s            39,000,000     0.333                1.000
668                                                                                                                                                                                                                                                                                                                                                                                                        
669                __m512d v_prod = _mm512_mul_pd(v_terma_sum, v_termb_sum);                                          0.040s                   0.040s                            0s                        0.040s                          0s                             0s                            0s                  0s                      0s           182,000,000     0.286                1.000
670                                                                                                                                                                                                                                                                                                                                                                                                        
671                /* check if scaling is needed for the current rate category */                                                                                                                                                                                                                                                                                                                          
672                rate_mask = _mm512_cmp_pd_mask(v_prod, v_scale_threshold, _CMP_LT_OS);                             0.110s                   0.110s                            0s                        0.110s                          0s                             0s                            0s                  0s                      0s            91,000,000     1.571                1.000
673                                                                                                                                                                                                                                                                                                                                                                                                        
674                _mm512_store_pd(parent_clv + 16, v_prod);                                                          0.050s                   0.050s                            0s                        0.050s                          0s                             0s                            0s                  0s                      0s            26,000,000     2.500                1.000
675                                                                                                                                                                                                                                                                                                                                                                                                        
676                if (scale_mode == 2) {                                                                             0.050s                   0.050s                            0s                        0.050s                          0s                             0s                            0s                  0s                      0s            13,000,000     5.000                1.000
677                  /* PER-RATE SCALING: if *all* entries of the *rate* CLV were below                                                                                                                                                                                                                                                                                                                    
678                 * the threshold then scale (all) entries by PLL_SCALE_FACTOR */                                                                                                                                                                                                                                                                                                                        
679                  if (rate_mask == 0xF) {                                                                                                                                                                                                                                                                                                                                                               
680                    for (i = 0; i < states_padded; i += ELEM_PER_AVX515_REGISTER) {                                                                                                                                                                                                                                                                                                                     
681                      __m512d v_prod = _mm512_load_pd(parent_clv + i);                                                                                                                                                                                                                                                                                                                                  
682                      v_prod = _mm512_mul_pd(v_prod, v_scale_factor);                                                                                                                                                                                                                                                                                                                                   
683                      _mm512_store_pd(parent_clv + i, v_prod);                                                                                                                                                                                                                                                                                                                                          
684                    }                                                                                                                                                                                                                                                                                                                                                                                   
685                    parent_scaler[n * rate_cats + k] += 1;                                                                                                                                                                                                                                                                                                                                              
686                  }                                                                                                                                                                                                                                                                                                                                                                                     
687                } else                                                                                                                                                                                                                                                                                                                                                                                  
688                  scale_mask = scale_mask & rate_mask;                                                                                                                                                                                                                                                                                                                                                  
689                                                                                                                                                                                                                                                                                                                                                                                                        
690                /* reset pointers to point to the start of the next p-matrix, as the                                                                                                                                                                                                                                                                                                                    
691                   vectorization assumes a square states_padded * states_padded matrix,                                                                                                                                                                                                                                                                                                                 
692                   even though the real matrix is states * states_padded */                                                                                                                                                                                                                                                                                                                             
693                lmat -= displacement;                                                                                                                                                                                                                                                                                                                                                                   
694                rmat -= displacement;                                                                                                                                                                                                                                                                                                                                                                   
695                                                                                                                                                                                                                                                                                                                                                                                                        
696                parent_clv += states_padded;                                                                                                                                                                                                                                                                                                                                                            
697                left_clv += states_padded;                                                                             0s                       0s                            0s                            0s                          0s                             0s                            0s                  0s                      0s            13,000,000     0.000                0.000
698                right_clv += states_padded;                                                                                                                                                                                                                                                                                                                                                             
699              }                                                                                                                                                                                                                                                                                                                                                                                         
700                                                                                                                                                                                                                                                                                                                                                                                                        
701              /* if *all* entries of the site CLV were below the threshold then scale                                                                                                                                                                                                                                                                                                                   
702                 (all) entries by PLL_SCALE_FACTOR */                                                                                                                                                                                                                                                                                                                                                   
703              if (scale_mask == 0xF) {                                                                                                                                                                                                                                                                                                                                                                  
704                parent_clv -= span_padded;                                                                             0s                       0s                            0s                            0s                          0s                             0s                            0s                  0s                      0s            13,000,000     0.000                0.000
705                for (i = 0; i < span_padded; i += ELEM_PER_AVX515_REGISTER) {                                                                                                                                                                                                                                                                                                                           
706                  __m512d v_prod = _mm512_load_pd(parent_clv + i);                                                                                                                                                                                                                                                                                                                                      
707                  v_prod = _mm512_mul_pd(v_prod, v_scale_factor);                                                                                                                                                                                                                                                                                                                                       
708                  _mm512_store_pd(parent_clv + i, v_prod);                                                                                                                                                                                                                                                                                                                                              
709                }                                                                                                                                                                                                                                                                                                                                                                                       
710                parent_clv += span_padded;                                                                                                                                                                                                                                                                                                                                                              
711                parent_scaler[n] += 1;                                                                                                                                                                                                                                                                                                                                                                  
712              }                                                                                                                                                                                                                                                                                                                                                                                         
713            }                                                                                                                                                                                                                                                                                                                                                                                           
714          }                                                                                                            0s                       0s                            0s                            0s                          0s                             0s                            0s                  0s                      0s            13,000,000     0.000                0.000
715                                                                                                                                                                                                                                                                                                                                                                                                        
716          PLL_EXPORT                                                                                                                                                                                                                                                                                                                                                                                    
717          void pll_core_update_partial_ti_20x20_avx512f(unsigned int sites,                                                                                                                                                                                                                                                                                                                             
718                                                        unsigned int rate_cats,                                                                                                                                                                                                                                                                                                                         
719                                                        double *parent_clv,                                                                                                                                                                                                                                                                                                                             
