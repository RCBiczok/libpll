Source Line  Source                                                                           CPU Time  CPU Time:Effective Time  CPU Time:Effective Time:Idle  CPU Time:Effective Time:Poor  CPU Time:Effective Time:Ok  CPU Time:Effective Time:Ideal  CPU Time:Effective Time:Over  CPU Time:Spin Time  CPU Time:Overhead Time  Instructions Retired  CPI Rate  CPU Frequency Ratio
-----------  -------------------------------------------------------------------------------  --------  -----------------------  ----------------------------  ----------------------------  --------------------------  -----------------------------  ----------------------------  ------------------  ----------------------  --------------------  --------  -------------------
549          //  }                                                                                                                                                                                                                                                                                                                                                                   
550          }                                                                                                                                                                                                                                                                                                                                                                       
551                                                                                                                                                                                                                                                                                                                                                                                  
552                                                                                                                                                                                                                                                                                                                                                                                  
553          PLL_EXPORT                                                                                                                                                                                                                                                                                                                                                              
554          void pll_core_update_partial_ii_20x20_avx512f(unsigned int sites,                                                                                                                                                                                                                                                                                                       
555                                                        unsigned int rate_cats,                                                                                                                                                                                                                                                                                                   
556                                                        double *parent_clv,                                                                                                                                                                                                                                                                                                       
557                                                        unsigned int *parent_scaler,                                                                                                                                                                                                                                                                                              
558                                                        const double *left_clv,                                                                                                                                                                                                                                                                                                   
559                                                        const double *right_clv,                                                                                                                                                                                                                                                                                                  
560                                                        const double *left_matrix,                                                                                                                                                                                                                                                                                                
561                                                        const double *right_matrix,                                                                                                                                                                                                                                                                                               
562                                                        const unsigned int *left_scaler,                                                                                                                                                                                                                                                                                          
563                                                        const unsigned int *right_scaler,                                                                                                                                                                                                                                                                                         
564                                                        unsigned int attrib) {               0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
565            unsigned int i, k, n;                                                                                                                                                                                                                                                                                                                                                 
566                                                                                                                                                                                                                                                                                                                                                                                  
567            const double *lmat;                                                                                                                                                                                                                                                                                                                                                   
568            const double *rmat;                                                                                                                                                                                                                                                                                                                                                   
569                                                                                                                                                                                                                                                                                                                                                                                  
570            unsigned int states = 20;                                                                                                                                                                                                                                                                                                                                             
571            unsigned int states_padded = (states + 7) & (0xFFFFFFFF - 7);                                                                                                                                                                                                                                                                                                         
572            unsigned int span_padded = states_padded * rate_cats;                            0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
573                                                                                                                                                                                                                                                                                                                                                                                  
574            /* scaling-related stuff */                                                                                                                                                                                                                                                                                                                                           
575            unsigned int scale_mode;  /* 0 = none, 1 = per-site, 2 = per-rate */                                                                                                                                                                                                                                                                                                  
576            unsigned int scale_mask;                                                                                                                                                                                                                                                                                                                                              
577            unsigned int init_mask;                                                                                                                                                                                                                                                                                                                                               
578            __m512d v_scale_threshold = _mm512_set1_pd(PLL_SCALE_THRESHOLD);                                                                                                                                                                                                                                                                                                      
579            __m256d v_scale_threshold_256 = _mm256_set1_pd(PLL_SCALE_THRESHOLD);                                                                                                                                                                                                                                                                                                  
580            __m512d v_scale_factor = _mm512_set1_pd(PLL_SCALE_FACTOR);                                                                                                                                                                                                                                                                                                            
581                                                                                                                                                                                                                                                                                                                                                                                  
582            __m512i permute_mask = _mm512_setr_epi64(0 | 4,                                                                                                                                                                                                                                                                                                                       
583                                                     0 | 5,                                                                                                                                                                                                                                                                                                                       
584                                                     0 | 6,                                                                                                                                                                                                                                                                                                                       
585                                                     0 | 7,                                                                                                                                                                                                                                                                                                                       
586                                                     8 | 0,                                                                                                                                                                                                                                                                                                                       
587                                                     8 | 1,                                                                                                                                                                                                                                                                                                                       
588                                                     8 | 2,                                                                                                                                                                                                                                                                                                                       
589                                                     8 | 3);                                                                                                                                                                                                                                                                                                                      
590            __m512i permute_mask_final_stage = _mm512_setr_epi64(0 | 2,                                                                                                                                                                                                                                                                                                           
591                                                                 0 | 3,                                                                                                                                                                                                                                                                                                           
592                                                                 8 | 0,                                                                                                                                                                                                                                                                                                           
593                                                                 8 | 1,                                                                                                                                                                                                                                                                                                           
594                                                                 0 | 6,                                                                                                                                                                                                                                                                                                           
595                                                                 0 | 7,                                                                                                                                                                                                                                                                                                           
596                                                                 8 | 4,                                                                                                                                                                                                                                                                                                           
597                                                                 8 | 5);                                                                                                                                                                                                                                                                                                          
598                                                                                                                                                                                                                                                                                                                                                                                  
599            if (!parent_scaler) {                                                                                                                                                                                                                                                                                                                                                 
600              /* scaling disabled / not required */                                                                                                                                                                                                                                                                                                                               
601              scale_mode = init_mask = 0;                                                                                                                                                                                                                                                                                                                                         
602            } else {                                                                                                                                                                                                                                                                                                                                                              
603              /* determine the scaling mode and init the vars accordingly */                                                                                                                                                                                                                                                                                                      
604              scale_mode = (attrib & PLL_ATTRIB_RATE_SCALERS) ? 2 : 1;                                                                                                                                                                                                                                                                                                            
605              init_mask = (scale_mode == 1) ? 0xF : 0;                                                                                                                                                                                                                                                                                                                            
606              const size_t scaler_size = (scale_mode == 2) ? sites * rate_cats : sites;                                                                                                                                                                                                                                                                                           
607              /* add up the scale vector of the two children if available */                                                                                                                                                                                                                                                                                                      
608              fill_parent_scaler(scaler_size, parent_scaler, left_scaler, right_scaler);                                                                                                                                                                                                                                                                                          
609            }                                                                                                                                                                                                                                                                                                                                                                     
610                                                                                                                                                                                                                                                                                                                                                                                  
611            size_t displacement = (states_padded - states) * (states_padded);                                                                                                                                                                                                                                                                                                     
612                                                                                                                                                                                                                                                                                                                                                                                  
613            /* compute CLV */                                                                                                                                                                                                                                                                                                                                                     
614            for (n = 0; n < sites; ++n) {                                                        0s                       0s                            0s                            0s                          0s                             0s                            0s                  0s                      0s            13,000,000     0.000                0.000
615              lmat = left_matrix;                                                                0s                       0s                            0s                            0s                          0s                             0s                            0s                  0s                      0s            13,000,000     0.000                0.000
616              rmat = right_matrix;                                                                                                                                                                                                                                                                                                                                                
617              scale_mask = init_mask;                                                                                                                                                                                                                                                                                                                                             
618                                                                                                                                                                                                                                                                                                                                                                                  
619              for (k = 0; k < rate_cats; ++k) {                                              0.030s                   0.030s                            0s                        0.030s                          0s                             0s                            0s                  0s                      0s            39,000,000     1.000                1.000
620                __mmask8 rate_mask = 0xF;                                                                                                                                                                                                                                                                                                                                         
621                                                                                                                                                                                                                                                                                                                                                                                  
622                PROCESS_8_COLUMNS(0);                                                        1.310s                   1.310s                            0s                        1.310s                          0s                             0s                            0s                  0s                      0s         2,106,000,000     0.809                1.000
623                PROCESS_8_COLUMNS(8);                                                        0.820s                   0.820s                            0s                        0.820s                          0s                             0s                            0s                  0s                      0s         1,781,000,000     0.599                1.000
624                                                                                                                                                                                                                                                                                                                                                                                  
625                __m256d v_terma0 = _mm256_setzero_pd();                                                                                                                                                                                                                                                                                                                           
626                __m256d v_termb0 = _mm256_setzero_pd();                                                                                                                                                                                                                                                                                                                           
627                __m256d v_terma1 = _mm256_setzero_pd();                                                                                                                                                                                                                                                                                                                           
628                __m256d v_termb1 = _mm256_setzero_pd();                                                                                                                                                                                                                                                                                                                           
629                __m256d v_terma2 = _mm256_setzero_pd();                                                                                                                                                                                                                                                                                                                           
630                __m256d v_termb2 = _mm256_setzero_pd();                                                                                                                                                                                                                                                                                                                           
631                __m256d v_terma3 = _mm256_setzero_pd();                                                                                                                                                                                                                                                                                                                           
632                __m256d v_termb3 = _mm256_setzero_pd();                                                                                                                                                                                                                                                                                                                           
633                                                                                                                                                                                                                                                                                                                                                                                  
634                __m256d v_mat;                                                                                                                                                                                                                                                                                                                                                    
635                __m256d v_lclv;                                                                                                                                                                                                                                                                                                                                                   
636                __m256d v_rclv;                                                                                                                                                                                                                                                                                                                                                   
637                                                                                                                                                                                                                                                                                                                                                                                  
638                /* point to the four rows of the left matrix */                                                                                                                                                                                                                                                                                                                   
639                const double *lm0 = lmat;                                                                                                                                                                                                                                                                                                                                         
640                const double *lm1 = lm0 + states_padded;                                                                                                                                                                                                                                                                                                                          
641                const double *lm2 = lm1 + states_padded;                                                                                                                                                                                                                                                                                                                          
642                const double *lm3 = lm2 + states_padded;                                                                                                                                                                                                                                                                                                                          
643                                                                                                                                                                                                                                                                                                                                                                                  
644                /* point to the four rows of the right matrix */                                                                                                                                                                                                                                                                                                                  
645                const double *rm0 = rmat;                                                                                                                                                                                                                                                                                                                                         
646                const double *rm1 = rm0 + states_padded;                                                                                                                                                                                                                                                                                                                          
647                const double *rm2 = rm1 + states_padded;                                                                                                                                                                                                                                                                                                                          
648                const double *rm3 = rm2 + states_padded;                                                                                                                                                                                                                                                                                                                          
649                                                                                                                                                                                                                                                                                                                                                                                  
650                /* iterate over quadruples of columns */                                                                                                                                                                                                                                                                                                                          
651                PROCESS_ROWS_AVX2(0);                                                        0.070s                   0.070s                            0s                        0.070s                          0s                             0s                            0s                  0s                      0s           143,000,000     0.636                1.000
652                PROCESS_ROWS_AVX2(4);                                                        0.030s                   0.030s                            0s                        0.030s                          0s                             0s                            0s                  0s                      0s           104,000,000     0.375                1.000
653                PROCESS_ROWS_AVX2(8);                                                        0.050s                   0.050s                            0s                        0.050s                          0s                             0s                            0s                  0s                      0s           117,000,000     0.556                1.000
654                PROCESS_ROWS_AVX2(12);                                                       0.110s                   0.110s                            0s                        0.110s                          0s                             0s                            0s                  0s                      0s           143,000,000     1.000                1.000
655                PROCESS_ROWS_AVX2(16);                                                       0.120s                   0.120s                            0s                        0.120s                          0s                             0s                            0s                  0s                      0s           312,000,000     0.500                1.000
656                                                                                                                                                                                                                                                                                                                                                                                  
657                /* point pmatrix to the next four rows */                                                                                                                                                                                                                                                                                                                         
658                lmat += 8*states_padded;                                                     0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
659                rmat += 8*states_padded;                                                     0.030s                   0.030s                            0s                        0.030s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
660                                                                                                                                                                                                                                                                                                                                                                                  
661                __m256d xmm0 = _mm256_unpackhi_pd(v_terma0, v_terma1);                       0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
662                __m256d xmm1 = _mm256_unpacklo_pd(v_terma0, v_terma1);                       0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s            13,000,000     1.000                1.000
663                                                                                                                                                                                                                                                                                                                                                                                  
664                __m256d xmm2 = _mm256_unpackhi_pd(v_terma2, v_terma3);                       0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s            13,000,000     1.000                1.000
665                __m256d xmm3 = _mm256_unpacklo_pd(v_terma2, v_terma3);                       0.020s                   0.020s                            0s                        0.020s                          0s                             0s                            0s                  0s                      0s            39,000,000     0.667                1.000
666                                                                                                                                                                                                                                                                                                                                                                                  
667                xmm0 = _mm256_add_pd(xmm0, xmm1);                                            0.020s                   0.020s                            0s                        0.020s                          0s                             0s                            0s                  0s                      0s            52,000,000     0.500                1.000
668                xmm1 = _mm256_add_pd(xmm2, xmm3);                                            0.060s                   0.060s                            0s                        0.060s                          0s                             0s                            0s                  0s                      0s           143,000,000     0.545                1.000
669                                                                                                                                                                                                                                                                                                                                                                                  
670                xmm2 = _mm256_permute2f128_pd(xmm0, xmm1, _MM_SHUFFLE(0, 2, 0, 1));          0.060s                   0.060s                            0s                        0.060s                          0s                             0s                            0s                  0s                      0s           143,000,000     0.545                1.000
671                                                                                                                                                                                                                                                                                                                                                                                  
672                xmm3 = _mm256_blend_pd(xmm0, xmm1, 12);                                      0.240s                   0.240s                            0s                        0.240s                          0s                             0s                            0s                  0s                      0s            78,000,000     4.000                1.000
673                                                                                                                                                                                                                                                                                                                                                                                  
674                __m256d v_terma_sum = _mm256_add_pd(xmm2, xmm3);                             0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
675                                                                                                                                                                                                                                                                                                                                                                                  
676                /* compute termb */                                                                                                                                                                                                                                                                                                                                               
677                                                                                                                                                                                                                                                                                                                                                                                  
678                xmm0 = _mm256_unpackhi_pd(v_termb0, v_termb1);                                                                                                                                                                                                                                                                                                                    
679                xmm1 = _mm256_unpacklo_pd(v_termb0, v_termb1);                                                                                                                                                                                                                                                                                                                    
680                                                                                                                                                                                                                                                                                                                                                                                  
681                xmm2 = _mm256_unpackhi_pd(v_termb2, v_termb3);                                                                                                                                                                                                                                                                                                                    
682                xmm3 = _mm256_unpacklo_pd(v_termb2, v_termb3);                                                                                                                                                                                                                                                                                                                    
683                                                                                                                                                                                                                                                                                                                                                                                  
684                xmm0 = _mm256_add_pd(xmm0, xmm1);                                            0.080s                   0.080s                        0.010s                        0.070s                          0s                             0s                            0s                  0s                      0s            13,000,000     8.000                1.000
685                xmm1 = _mm256_add_pd(xmm2, xmm3);                                            0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
686                                                                                                                                                                                                                                                                                                                                                                                  
687                xmm2 = _mm256_permute2f128_pd(xmm0, xmm1, _MM_SHUFFLE(0, 2, 0, 1));                                                                                                                                                                                                                                                                                               
688                                                                                                                                                                                                                                                                                                                                                                                  
689                xmm3 = _mm256_blend_pd(xmm0, xmm1, 12);                                      0.020s                   0.020s                            0s                        0.020s                          0s                             0s                            0s                  0s                      0s            26,000,000     1.000                1.000
690                                                                                                                                                                                                                                                                                                                                                                                  
691                __m256d v_termb_sum = _mm256_add_pd(xmm2, xmm3);                             0.030s                   0.030s                            0s                        0.030s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
692                                                                                                                                                                                                                                                                                                                                                                                  
693                __m256d v_prod = _mm256_mul_pd(v_terma_sum, v_termb_sum);                    0.020s                   0.020s                            0s                        0.020s                          0s                             0s                            0s                  0s                      0s            52,000,000     0.500                1.000
694                                                                                                                                                                                                                                                                                                                                                                                  
695                /* check if scaling is needed for the current rate category */                                                                                                                                                                                                                                                                                                    
696                __m256d v_cmp = _mm256_cmp_pd(v_prod, v_scale_threshold_256, _CMP_LT_OS);    0.090s                   0.090s                            0s                        0.090s                          0s                             0s                            0s                  0s                      0s            52,000,000     2.250                1.000
697                rate_mask = rate_mask & _mm256_movemask_pd(v_cmp);                           0.130s                   0.130s                            0s                        0.130s                          0s                             0s                            0s                  0s                      0s            65,000,000     2.600                1.000
698                                                                                                                                                                                                                                                                                                                                                                                  
699                _mm256_store_pd(parent_clv + 16, v_prod);                                    0.020s                   0.020s                            0s                        0.020s                          0s                             0s                            0s                  0s                      0s            39,000,000     0.667                1.000
700                                                                                                                                                                                                                                                                                                                                                                                  
701                if (scale_mode == 2) {                                                       0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
702                  /* PER-RATE SCALING: if *all* entries of the *rate* CLV were below                                                                                                                                                                                                                                                                                              
703                 * the threshold then scale (all) entries by PLL_SCALE_FACTOR */                                                                                                                                                                                                                                                                                                  
704                  if (rate_mask == 0xF) {                                                                                                                                                                                                                                                                                                                                         
705                    for (i = 0; i < states_padded; i += ELEM_PER_AVX515_REGISTER) {                                                                                                                                                                                                                                                                                               
706                      __m512d v_prod = _mm512_load_pd(parent_clv + i);                                                                                                                                                                                                                                                                                                            
707                      v_prod = _mm512_mul_pd(v_prod, v_scale_factor);                                                                                                                                                                                                                                                                                                             
708                      _mm512_store_pd(parent_clv + i, v_prod);                                                                                                                                                                                                                                                                                                                    
709                    }                                                                                                                                                                                                                                                                                                                                                             
710                    parent_scaler[n * rate_cats + k] += 1;                                                                                                                                                                                                                                                                                                                        
711                  }                                                                                                                                                                                                                                                                                                                                                               
712                } else                                                                                                                                                                                                                                                                                                                                                            
713                  scale_mask = scale_mask & rate_mask;                                       0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
714                                                                                                                                                                                                                                                                                                                                                                                  
715                /* reset pointers to point to the start of the next p-matrix, as the                                                                                                                                                                                                                                                                                              
716                   vectorization assumes a square states_padded * states_padded matrix,                                                                                                                                                                                                                                                                                           
717                   even though the real matrix is states * states_padded */                                                                                                                                                                                                                                                                                                       
718                lmat -= displacement;                                                                                                                                                                                                                                                                                                                                             
719                rmat -= displacement;                                                                                                                                                                                                                                                                                                                                             
720                                                                                                                                                                                                                                                                                                                                                                                  
721                parent_clv += states_padded;                                                 0.010s                   0.010s                            0s                        0.010s                          0s                             0s                            0s                  0s                      0s            13,000,000     1.000                1.000
722                left_clv += states_padded;                                                                                                                                                                                                                                                                                                                                        
723                right_clv += states_padded;                                                  0.020s                   0.020s                            0s                        0.020s                          0s                             0s                            0s                  0s                      0s                     0                          1.000
724              }                                                                                                                                                                                                                                                                                                                                                                   
725                                                                                                                                                                                                                                                                                                                                                                                  
726              /* if *all* entries of the site CLV were below the threshold then scale                                                                                                                                                                                                                                                                                             
727                 (all) entries by PLL_SCALE_FACTOR */                                                                                                                                                                                                                                                                                                                             
728              if (scale_mask == 0xF) {                                                                                                                                                                                                                                                                                                                                            
729                parent_clv -= span_padded;                                                                                                                                                                                                                                                                                                                                        
730                for (i = 0; i < span_padded; i += ELEM_PER_AVX515_REGISTER) {                                                                                                                                                                                                                                                                                                     
731                  __m512d v_prod = _mm512_load_pd(parent_clv + i);                                                                                                                                                                                                                                                                                                                
732                  v_prod = _mm512_mul_pd(v_prod, v_scale_factor);                                                                                                                                                                                                                                                                                                                 
733                  _mm512_store_pd(parent_clv + i, v_prod);                                                                                                                                                                                                                                                                                                                        
734                }                                                                                                                                                                                                                                                                                                                                                                 
735                parent_clv += span_padded;                                                                                                                                                                                                                                                                                                                                        
736                parent_scaler[n] += 1;                                                                                                                                                                                                                                                                                                                                            
737              }                                                                                                                                                                                                                                                                                                                                                                   
738            }                                                                                                                                                                                                                                                                                                                                                                     
739          }                                                                                                                                                                                                                                                                                                                                                                       
740                                                                                                                                                                                                                                                                                                                                                                                  
741          PLL_EXPORT                                                                                                                                                                                                                                                                                                                                                              
742          void pll_core_update_partial_ti_20x20_avx512f(unsigned int sites,                                                                                                                                                                                                                                                                                                       
743                                                        unsigned int rate_cats,                                                                                                                                                                                                                                                                                                   
744                                                        double *parent_clv,                                                                                                                                                                                                                                                                                                       
